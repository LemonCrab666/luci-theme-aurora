import{c as t,s as e}from"./utils-DKirHKlh.js";class s{constructor(){this.form=null,this.submitButton=null,this.dialog=null,this.isLoading=!1}init(){this.setupForm(),this.setupEventListeners(),this.focusPasswordInput()}setupForm(){this.form=document.querySelector("form"),this.submitButton=document.querySelector('button.important, button[type="submit"]'),this.form&&this.submitButton}setupEventListeners(){this.form&&this.submitButton&&(this.form.addEventListener("keypress",t=>{"Enter"!==t.key||this.isLoading||(t.preventDefault(),this.handleSubmit())}),this.submitButton.addEventListener("click",t=>{t.preventDefault(),this.isLoading||this.handleSubmit()}),this.form.querySelectorAll("input[required]").forEach(t=>{t.addEventListener("blur",()=>this.validateInput(t)),t.addEventListener("input",()=>this.clearInputError(t))}))}focusPasswordInput(){const t=document.querySelector('input[type="password"]');t&&setTimeout(()=>{t.focus()},100)}async handleSubmit(){if(this.validateForm()){this.setLoading(!0);try{await this.showLoginDialog(),await this.submitForm()}catch(t){this.showError("登录过程中发生错误，请重试")}}}validateForm(){const t=this.form.querySelectorAll("input[required]");let e=!0;return t.forEach(t=>{this.validateInput(t)||(e=!1)}),e}validateInput(t){const e=t.value.trim().length>0;return e?this.clearInputError(t):this.showInputError(t,"此字段为必填项"),e}showInputError(e,s){e.classList.add("border-red-500","focus:ring-red-500","focus:border-red-500");const r=e.parentElement.querySelector(".error-message");r&&r.remove();const i=t("div",{class:"error-message text-sm text-red-600 mt-1"},[s]);e.parentElement.appendChild(i)}clearInputError(t){t.classList.remove("border-red-500","focus:ring-red-500","focus:border-red-500");const e=t.parentElement.querySelector(".error-message");e&&e.remove()}async showLoginDialog(){if("undefined"==typeof ui||!ui.showModal)return;const t=Array.from(document.querySelectorAll("section > *"));this.dialog=ui.showModal(_("授权验证"),t,"login"),this.dialog&&this.dialog.classList.add("transition-all","duration-300","transform","bg-white","dark:bg-gray-800","rounded-lg","shadow-2xl")}setLoading(e){if(this.isLoading=e,e){if(this.dialog){this.dialog.querySelectorAll("*").forEach(t=>{t.style.display="none"});const e=t("div",{class:"flex items-center justify-center p-8"},[t("div",{class:"spinning w-6 h-6 mr-3"}),t("span",{class:"text-gray-700 dark:text-gray-300"},[_("正在登录…")])]);this.dialog.appendChild(e)}this.submitButton&&(this.submitButton.disabled=!0,this.submitButton.classList.add("opacity-50","cursor-not-allowed"))}else this.submitButton&&(this.submitButton.disabled=!1,this.submitButton.classList.remove("opacity-50","cursor-not-allowed"))}async submitForm(){return new Promise((t,e)=>{const s=()=>{this.form.removeEventListener("submit",s),t()},r=t=>{this.form.removeEventListener("error",r),e(t)};this.form.addEventListener("submit",s),this.form.addEventListener("error",r);try{this.form.submit()}catch(t){e(t)}})}showError(t){this.setLoading(!1),e(t,"error")}reset(){this.setLoading(!1),this.form&&(this.form.reset(),this.form.querySelectorAll("input").forEach(t=>this.clearInputError(t)))}}const r=new s;"undefined"!=typeof window&&(window.AuthenticationHandler=s),"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",()=>{document.querySelector("form")&&document.querySelector('input[type="password"]')&&r.init()});export{r as a};
